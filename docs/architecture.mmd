flowchart TD
    subgraph "User Interaction & Edge"
        A["Web Clients or Bots"] -- HTTP/S Request --> B(NGINX Port 80/443);
        B -- Checks --> C{"Blocklist Check (Lua + Redis DB 2)"};
        C -- Blocked --> D[Return 403];
        C -- Not Blocked --> E{"Heuristic Check (Lua)"};
        E -- Passed --> G["Proxy Pass"];
        E -- Suspicious --> F["Internal Redirect /api/tarpit"];
    end

    subgraph "Real Application"
        G --> I[Your Web Application];
    end

    subgraph "Tarpit & Escalation Pipeline"
        F --> H(Tarpit API - FastAPI);
        H -- Logs Hit --> R["logs/honeypot_hits.log"];
        H -- Flags IP --> RedisDB1[(Redis DB 1 Tarpit Flags)];
        H -- Updates --> MetricsStore[(Metrics Store)];
        H -- POST Metadata --> L(Escalation Engine - FastAPI);

        L -- Uses/Updates --> RedisDB3[(Redis DB 3 Freq Tracking)];
        L -- Updates --> MetricsStore;
        L -- If Malicious --> M(AI Service - FastAPI);
    end

    subgraph "AI Service & Actions"
        M -- Adds IP --> RedisDB2[(Redis DB 2 Blocklist Set)];
        M -- Updates --> MetricsStore;
        M -- Sends Alerts --> P{"Alert Dispatcher"};
        P -- Configured Method --> Q[External Systems: Slack, Email, SIEM, Fail2ban...];
    end

    subgraph "Monitoring"
        MetricsStore -- Provides Data --> MetricsEndpoint["/admin/metrics Endpoint"];
        Y(Admin UI - Flask) -- Fetches --> MetricsEndpoint;
        Y --> Z[Admin Dashboard];
    end

    subgraph "Background & Training Tasks"
        R -- Read By --> S(Training Script rag/training.py);
        S -- Trains --> T[Random Forest Model];
        T -- Saves --> U["./models/*.joblib"];

        V(Archive Rotator - Scheduled) -- Manages --> W["./archives ZIPs"];
    end

    %% Styling (Optional)
    classDef nginx fill:#f9f,stroke:#333,stroke-width:2px;
    classDef api fill:#ccf,stroke:#333,stroke-width:1px;
    classDef redis fill:#ff9,stroke:#333,stroke-width:1px;
    classDef storage fill:#eee,stroke:#333,stroke-width:1px;
    classDef task fill:#cfc,stroke:#333,stroke-width:1px;
    classDef external fill:#fcc,stroke:#333,stroke-width:1px;

    class B nginx;
    class H,L,M,Y api;
    class RedisDB1,RedisDB2,RedisDB3 redis;
    class R,U,W storage;
    class S,V task;
    class Q external;