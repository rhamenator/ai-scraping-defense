# Fail2ban Integration

`fail2ban` monitors log files and inserts temporary firewall rules when malicious activity is detected. In this project it watches the Nginx error log for entries generated by the Lua blocklist logic.

## Configuration Files

The repository ships with a minimal jail and filter under `fail2ban/`. The `nginx-blocklist` jail bans an address whenever the log line `check_blocklist: Blocking IP <ip>` appears. By default the jail uses a `bantime` of **86400** seconds (one day) and a `findtime` of **300** seconds with `maxretry` set to **1**.

By default the jail now relies on an **ipset** based action named `ipset-ddos`. When Fail2ban starts it creates an `ipset` called `ddos-block` and inserts a global iptables rule dropping any packets from addresses in this set. Banned IPs are added to `ddos-block` for efficient kernel-level filtering.

These values can be tuned by editing `fail2ban/jail.d/nginx-blocklist.conf` or the corresponding ConfigMap in `kubernetes/fail2ban-deployment.yaml`.

- `bantime` – how long an IP remains blocked.
- `findtime` – the window for counting retries before a ban.

Adjust them to match the Redis TTL or your preferred policy.

## Enabling with Docker Compose

The Compose file already defines a `fail2ban` service. Start it alongside the stack:

```bash
docker compose up -d fail2ban
```

It runs in host network mode and mounts the Nginx logs and configuration directory.

## Enabling on Kubernetes

1. Apply `kubernetes/nginx-logs-pvc.yaml` and mount this volume in the Nginx deployment so logs are accessible.
2. Deploy `kubernetes/fail2ban-deployment.yaml`:

```bash
kubectl apply -f kubernetes/fail2ban-deployment.yaml
```

The deployment mounts the same log volume and installs the jail/filter via a ConfigMap. Modify the ConfigMap to customize `bantime` or `findtime` before applying it.

Fail2ban requires the `NET_ADMIN` and `NET_RAW` capabilities to insert firewall rules. Review these permissions to ensure they comply with your security requirements.
