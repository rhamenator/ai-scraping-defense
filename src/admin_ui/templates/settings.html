<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - AI Scraping Defense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='settings.css') }}">
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">AI Scraping Defense</h1>
            <p class="text-gray-600">System Configuration</p>
            <nav class="mt-4">
                <a href="/" class="text-blue-600 hover:underline mr-4">Dashboard</a>
                <a href="/settings" class="text-blue-800 font-semibold mr-4">Settings</a>
                <a href="/logs" class="text-blue-600 hover:underline mr-4">Logs</a>
                <a href="/plugins" class="text-blue-600 hover:underline">Plugins</a>
            </nav>
        </header>

        <main>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Current System Settings</h2>
                <p class="text-gray-600 mb-6">
                    This page displays the current non-sensitive configuration loaded from the environment.
                    For security, sensitive values like API keys and passwords are not shown here.
                </p>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 border-b text-left">Setting</th>
                                <th class="py-2 px-4 border-b text-left">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in settings.items() %}
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-4 border-b font-mono text-sm text-gray-700">{{ key }}</td>
                                <td class="py-2 px-4 border-b font-mono text-sm text-blue-800">{{ value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <form method="post" class="mt-6 space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% if updated %}
                    <div class="text-green-700">Settings updated.</div>
                    {% endif %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="LOG_LEVEL">Log Level</label>
                        <input class="mt-1 p-2 border rounded w-full" type="text" name="LOG_LEVEL" id="LOG_LEVEL" value="{{ settings['LOG_LEVEL'] }}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="ESCALATION_ENDPOINT">Escalation Engine URL</label>
                        <input class="mt-1 p-2 border rounded w-full" type="text" name="ESCALATION_ENDPOINT" id="ESCALATION_ENDPOINT" value="{{ settings['ESCALATION_ENDPOINT'] }}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="WEBAUTHN_AUTHENTICATOR_ATTACHMENT">WebAuthn Authenticator Preference</label>
                        <select class="mt-1 p-2 border rounded w-full" name="WEBAUTHN_AUTHENTICATOR_ATTACHMENT" id="WEBAUTHN_AUTHENTICATOR_ATTACHMENT">
                            <option value="none" {% if settings['WEBAUTHN_AUTHENTICATOR_ATTACHMENT'] == 'none' %}selected{% endif %}>No preference</option>
                            <option value="platform" {% if settings['WEBAUTHN_AUTHENTICATOR_ATTACHMENT'] == 'platform' %}selected{% endif %}>Platform (biometric-capable)</option>
                            <option value="cross-platform" {% if settings['WEBAUTHN_AUTHENTICATOR_ATTACHMENT'] == 'cross-platform' %}selected{% endif %}>Cross-platform (security keys)</option>
                        </select>
                    </div>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Save</button>
                </form>

                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-blue-800">How to Change Settings</h3>
                    <p class="mt-2 text-sm text-blue-700">
                        Some basic options can be updated using the form above.
                        For other values, modify your <strong>.env</strong> file and restart the services with <code>docker-compose up -d --build</code>.
                    </p>
                    <p class="mt-2 text-sm text-blue-700">
                        In production environments, update your <strong>ConfigMap</strong> and <strong>Secret</strong> manifests and re-apply them using <code>kubectl apply -f ...</code>.
                    </p>
                </div>
            </div>

            <!-- GDPR Compliance Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                <h2 class="text-2xl font-semibold mb-4">GDPR Compliance</h2>
                <p class="text-gray-600 mb-6">
                    This system implements comprehensive GDPR compliance features including consent management,
                    right to be forgotten, data minimization, and automated compliance reporting.
                </p>

                {% if gdpr_report %}
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Compliance Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 rounded">
                            <p class="text-sm text-gray-600">GDPR Enabled</p>
                            <p class="text-lg font-bold text-blue-600">{{ gdpr_report.get('gdpr_enabled', 'N/A') }}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded">
                            <p class="text-sm text-gray-600">Data Retention (Days)</p>
                            <p class="text-lg font-bold text-blue-600">{{ gdpr_report.get('data_retention_days', 'N/A') }}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded">
                            <p class="text-sm text-gray-600">Consent Records</p>
                            <p class="text-lg font-bold text-blue-600">{{ gdpr_report.get('statistics', {}).get('total_consent_records', 0) }}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded">
                            <p class="text-sm text-gray-600">Deletion Requests</p>
                            <p class="text-lg font-bold text-blue-600">{{ gdpr_report.get('statistics', {}).get('total_deletion_requests', 0) }}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Data Protection Officer</h3>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm"><strong>Name:</strong> {{ gdpr_report.get('dpo_contact', {}).get('name', 'N/A') }}</p>
                        <p class="text-sm"><strong>Email:</strong> {{ gdpr_report.get('dpo_contact', {}).get('email', 'N/A') }}</p>
                        {% if gdpr_report.get('dpo_contact', {}).get('phone') %}
                        <p class="text-sm"><strong>Phone:</strong> {{ gdpr_report.get('dpo_contact', {}).get('phone') }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Data Deletion Request</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Submit a request to delete user data (Right to be Forgotten).
                    </p>
                    <form id="deletionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="user_id">User ID</label>
                            <input class="mt-1 p-2 border rounded w-full" type="text" name="user_id" id="user_id" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="email">Email (Optional)</label>
                            <input class="mt-1 p-2 border rounded w-full" type="email" name="email" id="email">
                        </div>
                        <button class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700" type="submit">
                            Submit Deletion Request
                        </button>
                    </form>
                    <div id="deletionResult" class="mt-4"></div>
                </div>

                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-yellow-800">Documentation</h3>
                    <p class="mt-2 text-sm text-yellow-700">
                        For complete GDPR compliance documentation, see:
                    </p>
                    <ul class="mt-2 text-sm text-yellow-700 list-disc list-inside">
                        <li><strong>docs/privacy_policy.md</strong> - Privacy policy and user rights</li>
                        <li><strong>docs/legal_compliance.md</strong> - GDPR implementation details</li>
                        <li><strong>src/shared/gdpr.py</strong> - GDPR compliance module</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Handle deletion request form submission
        document.getElementById('deletionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const resultDiv = document.getElementById('deletionResult');

            try {
                const response = await fetch('/gdpr/deletion-request', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800"><strong>Success!</strong></p>
                            <p class="text-sm text-green-700">Request ID: ${result.request_id}</p>
                            <p class="text-sm text-green-700">${result.message}</p>
                        </div>
                    `;
                    e.target.reset();
                } else {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded">
                            <p class="text-red-800"><strong>Error:</strong> ${result.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <p class="text-red-800"><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
