name: CI Tests (Linux, Windows, macOS)
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (staging|production|preview)"
        required: false
      ref:
        description: "Git ref to run against"
        required: false
  pull_request:
    branches: ["main"]
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ (github.event_name == 'workflow_dispatch' && (inputs.environment || github.ref)) || github.ref }}
  cancel-in-progress: true
jobs:
  tests-linux:
    permissions:
      contents: read
      checks: write
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with: { fetch-depth: 0 }
      - name: Set up Python
        if: hashFiles('**/*.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Set up Rust toolchain
        if: hashFiles('**/Cargo.toml') != ''
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
      - name: Python tests
        if: hashFiles('**/*.py') != ''
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi
          if [ -f setup.py ]; then pip install -e .; fi
          pip install kubernetes
          pip install pytest pytest-cov
          pytest -q test/
      - name: Rust tests
        if: hashFiles('**/Cargo.toml') != ''
        env:
          RUSTFLAGS: "-C target-cpu=generic -C target-feature=-avx,-avx2"
        run: |
          sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev
          set -e
          for crate in jszip-rs markov-train-rs tarpit-rs frequency-rs; do
            if [ -d "$crate" ]; then
              echo "Testing $crate..."
              cargo test --manifest-path "$crate/Cargo.toml" --locked 2>locked.log || {
                if grep -q "Cargo.lock needs to be updated" locked.log || grep -q "which is not allowed due to --locked" locked.log; then
                  echo "Falling back to unlocked dependencies for $crate due to lock file error."
                  cargo test --manifest-path "$crate/Cargo.toml"
                else
                  echo "cargo test failed for $crate for a reason other than lock file issues."
                  cat locked.log
                  exit 1
                fi
              }
              cargo clippy --manifest-path "$crate/Cargo.toml" --all-targets --all-features -- -D warnings
              cargo fmt --manifest-path "$crate/Cargo.toml" -- --check
            fi
          done
      - name: Node tests
        if: hashFiles('**/package.json') != ''
        run: |
          if [ -f package-lock.json ]; then npm ci --ignore-scripts || npm i; else npm i; fi
          if npm run | grep -q " test"; then npm test --silent; else echo "No npm test script"; fi
      - name: Lint Shell
        if: hashFiles('**/*.sh') != ''
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          (shopt -s globstar nullglob; for f in **/*.sh; do shellcheck -x -S error "$f"; done)
      - name: Lint Lua
        if: hashFiles('**/*.lua') != ''
        run: |
          sudo apt-get update && sudo apt-get install -y luarocks lua5.4
          sudo luarocks install luacheck
          luacheck .
      - name: Validate NGINX configs (syntax only)
        if: hashFiles('nginx/*.conf') != '' || hashFiles('nginx/**/*.conf') != ''
        run: docker run --rm -v "$PWD/nginx:/etc/nginx:ro" nginx:stable nginx -t -c /etc/nginx/nginx.conf
      - name: Set up Helm
        uses: azure/setup-helm@v4
      - name: Helm/K8s lint
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz -o /tmp/kubeconform.tar.gz
          sudo tar -xzf /tmp/kubeconform.tar.gz -C /usr/local/bin
          if [ -d helm/ai-scraping-defense-v9 ]; then
            helm lint helm/ai-scraping-defense-v9
            helm template helm/ai-scraping-defense-v9 | kubeconform -ignore-missing-schemas -strict
          fi
  tests-windows:
    permissions:
      contents: read
      checks: write
    runs-on: windows-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with: { fetch-depth: 0 }
      - name: Set up Python
        if: hashFiles('**/*.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Python tests (Windows)
        shell: pwsh
        run: |
          python -m venv .venv
          . .\.venv\Scripts\Activate.ps1
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { python -m pip install -r requirements.txt }
          if (Test-Path pyproject.toml) { python -m pip install . }
          if (Test-Path setup.py) { python -m pip install -e . }
          python -m pip install kubernetes
          python -m pip install pytest pytest-cov
          pytest -q test/
      - name: Node tests (Windows)
        if: hashFiles('**/package.json') != ''
        shell: pwsh
        run: |
          if (Test-Path package-lock.json) { npm ci --ignore-scripts } else { npm i }
          if ((npm run) -match ' test') { npm test --silent } else { echo "No npm test script" }
      - name: PowerShell Analyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          Get-ChildItem -Recurse -Filter *.ps1 | ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Recurse -Severity Warning -OutVariable issues } ; $issues | Format-Table
  tests-macos:
    permissions:
      contents: read
      checks: write
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with: { fetch-depth: 0 }
      - name: Set up Python
        if: hashFiles('**/*.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install libpq (pg_config) and libomp
        if: hashFiles('requirements.txt') != ''
        run: |
          brew install libpq
          brew install libomp
          echo "$(brew --prefix libpq)/bin" >> "$GITHUB_PATH"
      - name: Python tests (macOS)
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then python -m pip install .; fi
          if [ -f setup.py ]; then python -m pip install -e .; fi
          python -m pip install kubernetes
          python -m pip install pytest pytest-cov
          pytest -q test/
      - name: Node tests (macOS)
        if: hashFiles('**/package.json') != ''
        run: |
          if [ -f package-lock.json ]; then npm ci --ignore-scripts || npm i; else npm i; fi
          if npm run | grep -q " test"; then npm test --silent; else echo "No npm test script"; fi
      - name: Run macOS helper scripts (best-effort)
        run: |
          [ -f "./scripts/macos/setup.zsh" ] && zsh ./scripts/macos/setup.zsh || true
          [ -f "./scripts/macos/test.zsh" ] && zsh ./scripts/macos/test.zsh || true
