name: pip-audit (Supply Chain Security)
permissions:
  contents: read
  security-events: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'requirements.txt'
      - 'requirements.lock'
  pull_request:
    paths:
      - 'requirements.txt'
      - 'requirements.lock'
  schedule:
    - cron: '0 6 * * 0'

jobs:
  audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit
      
      - name: Verify dependency integrity
        run: |
          python scripts/security/verify_dependencies.py
      
      - name: Run pip-audit (vulnerability scan)
        run: |
          pip-audit -r requirements.txt -f sarif -o pip-audit.sarif
      
      - name: Run pip-audit (JSON report)
        run: |
          pip-audit -r requirements.txt -f json -o pip-audit-report.json || true
      
      - name: Check for compromised packages
        run: |
          # Check for known compromised package patterns
          if grep -iE "(requests2|urllib4|python-mysql|setup-tools)" requirements.txt requirements.lock; then
            echo "::warning::Found potential typosquatting package names"
          fi
      
      - name: Verify package sources
        run: |
          # Ensure no suspicious index URLs
          if grep -E "^--index-url.*http://" requirements.txt; then
            echo "::error::Insecure HTTP index URL detected"
            exit 1
          fi
      
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@528ca598d956c91826bd742262cdfc5d02b77710
        with:
          sarif_file: pip-audit.sarif
        if: always()
      
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json
        if: always()
