name: pip-audit
permissions:
  contents: read
  security-events: write
  issues: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 0'
  pull_request:
    paths:
      - 'requirements.txt'
      - 'requirements.lock'
      - 'constraints.txt'

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit safety
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run pip-audit with vulnerability prioritization
        run: |
          echo "Running pip-audit vulnerability scan..."
          pip-audit -r requirements.txt -f sarif -o pip-audit.sarif || true
          pip-audit -r requirements.txt -f json -o reports/pip-audit.json || true
          pip-audit -r requirements.txt --desc on > reports/pip-audit-detailed.txt || true
      
      - name: Run safety check for additional vulnerability data
        run: |
          echo "Running safety check for comprehensive vulnerability data..."
          safety check -r requirements.txt --json > reports/safety-check.json || true
          safety check -r requirements.txt --full-report > reports/safety-detailed.txt || true
      
      - name: Prioritize vulnerabilities by severity
        run: |
          python3 - <<'EOF'
          import json
          import os
          
          def load_pip_audit_vulnerabilities():
              try:
                  with open('reports/pip-audit.json', 'r') as f:
                      data = json.load(f)
                      return data.get('dependencies', [])
              except:
                  return []
          
          def prioritize_vulnerabilities(vulnerabilities):
              priority_map = {
                  'critical': [],
                  'high': [],
                  'medium': [],
                  'low': []
              }
              
              for vuln in vulnerabilities:
                  vulns_list = vuln.get('vulns', [])
                  for v in vulns_list:
                      severity = 'medium'  # default
                      # Extract severity from advisory or description
                      if 'critical' in str(v).lower():
                          severity = 'critical'
                      elif 'high' in str(v).lower():
                          severity = 'high'
                      elif 'low' in str(v).lower():
                          severity = 'low'
                      
                      priority_map[severity].append({
                          'package': vuln.get('name'),
                          'version': vuln.get('version'),
                          'vulnerability': v
                      })
              
              return priority_map
          
          vulns = load_pip_audit_vulnerabilities()
          prioritized = prioritize_vulnerabilities(vulns)
          
          with open('reports/vulnerability-priorities.json', 'w') as f:
              json.dump(prioritized, f, indent=2)
          
          # Generate summary
          total = sum(len(v) for v in prioritized.values())
          print(f"Vulnerability Prioritization Summary:")
          print(f"  Critical: {len(prioritized['critical'])}")
          print(f"  High: {len(prioritized['high'])}")
          print(f"  Medium: {len(prioritized['medium'])}")
          print(f"  Low: {len(prioritized['low'])}")
          print(f"  Total: {total}")
          
          # Write summary to file
          with open('reports/vulnerability-summary.txt', 'w') as f:
              f.write(f"Vulnerability Summary\n")
              f.write(f"====================\n\n")
              f.write(f"Critical: {len(prioritized['critical'])}\n")
              f.write(f"High: {len(prioritized['high'])}\n")
              f.write(f"Medium: {len(prioritized['medium'])}\n")
              f.write(f"Low: {len(prioritized['low'])}\n")
              f.write(f"Total: {total}\n")
          EOF
      
      - name: Generate vulnerability report
        run: |
          echo "## ðŸ”’ Python Dependency Vulnerability Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat reports/vulnerability-summary.txt >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@528ca598d956c91826bd742262cdfc5d02b77710
        with:
          sarif_file: pip-audit.sarif
      
      - name: Upload detailed vulnerability reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: vulnerability-reports
          path: reports/
          retention-days: 90
