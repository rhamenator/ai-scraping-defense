---
name: Reopen Issues Without Merged PRs

'on':
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (no changes made)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      limit:
        description: "Maximum number of issues/PRs to check"
        required: false
        default: "500"
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"

permissions:
  issues: write
  pull-requests: read

jobs:
  reopen-unlinked-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: "3.11"

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || \
            (sudo apt update && sudo apt install curl -y)
          curl -fsSL \
            https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
            sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r \
            /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) \
            signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] \
            https://cli.github.com/packages stable main" | \
            sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Verify GitHub CLI authentication
        run: gh auth status

      - name: Run reopen script
        run: |
          DRY_RUN_FLAG=""
          LIMIT_FLAG=""

          # Set dry-run flag based on input or default to true
          # for scheduled runs
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # For scheduled runs, default to dry-run unless
            # explicitly disabled
            DRY_RUN_FLAG="--dry-run"
          elif [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          # Set limit if provided
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_FLAG="--limit ${{ inputs.limit }}"
          fi

          python scripts/reopen_unlinked_issues.py \
            $DRY_RUN_FLAG $LIMIT_FLAG --log-level INFO

      - name: Create summary
        if: always()
        run: |
          echo "## Reopen Unlinked Issues Workflow" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" \
            >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: \
            ${{ inputs.dry_run || 'true (scheduled)' }}" \
            >> $GITHUB_STEP_SUMMARY
          echo "- **Limit**: ${{ inputs.limit || '500' }}" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details on \
            issues processed." >> $GITHUB_STEP_SUMMARY
