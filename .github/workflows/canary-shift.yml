name: Canary Shift
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (staging|production|preview)"
        required: false
      ref:
        description: "Git ref to run against"
        required: false
      weight: { description: "Canary weight (0-100)", required: true, type: number }
      namespace: { description: "Kubernetes namespace", required: false, default: production }
      canary_ingress: { description: "Canary ingress name", required: false, default: ai-scraping-defense-canary }
      primary_ingress: { description: "Primary ingress name", required: false, default: ai-scraping-defense }
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ inputs.environment || github.ref }}
  cancel-in-progress: true
jobs:
  shift:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: google-github-actions/get-gke-credentials@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GCP_REGION }}
      - name: Set weight
        run: |
          kubectl -n "${{ inputs.namespace }}" annotate ingress "${{ inputs.canary_ingress }}" \
            nginx.ingress.kubernetes.io/canary="true" \
            nginx.ingress.kubernetes.io/canary-weight="${{ inputs.weight }}" --overwrite

          kubectl -n "${{ inputs.namespace }}" get ingress "${{ inputs.canary_ingress }}" -o yaml

      - name: Disable canary (set weight to 0)
        if: ${{ inputs.weight == 0 }}
        run: |
          kubectl -n "${{ inputs.namespace }}" annotate ingress "${{ inputs.canary_ingress }}" \
            nginx.ingress.kubernetes.io/canary="false" \
            nginx.ingress.kubernetes.io/canary-weight="0" --overwrite

          kubectl -n "${{ inputs.namespace }}" get ingress "${{ inputs.canary_ingress }}" -o yaml
