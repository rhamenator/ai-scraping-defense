name: security-controls

on:
  push:
    branches: ["main", "develop", "security/*"]
  pull_request:
  schedule:
    - cron: "0 6 * * *"

# Enforce least privilege for GITHUB_TOKEN across all jobs
permissions:
  contents: read

jobs:
  python-security:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -c constraints.txt
          pip install bandit pip-audit
      - name: Static security checks
        run: |
          scripts/security/run_static_security_checks.py
          bandit -q -r src
      - name: Targeted security tests
        run: |
          pytest test/test_security_baselines.py test/test_security_middleware.py test/test_security_inventory.py
      - name: Dependency audit
        run: |
          pip-audit

  container-scan:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: fs
          scan-path: .
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: table
          exit-code: '0'

  compose-config-scan:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: config
          scan-path: .
          severity: CRITICAL,HIGH
          format: table
          exit-code: '0'

  container-image-scan:
    permissions:
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile:
          - path: .
            context: .
            image: ai-scraping-defense-core
          - path: proxy
            context: proxy
            image: ai-scraping-defense-proxy
          - path: cloud-proxy
            context: cloud-proxy
            image: ai-scraping-defense-cloud-proxy
          - path: prompt-router
            context: prompt-router
            image: ai-scraping-defense-prompt-router
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.dockerfile.context }}
          file: ${{ matrix.dockerfile.path }}/Dockerfile
          tags: ${{ matrix.dockerfile.image }}:scan
          push: false
          load: true
      - name: Run Trivy vulnerability scanner on image
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ matrix.dockerfile.image }}:scan
          format: sarif
          output: trivy-results-${{ matrix.dockerfile.image }}.sarif
          severity: CRITICAL,HIGH
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results-${{ matrix.dockerfile.image }}.sarif
          category: trivy-${{ matrix.dockerfile.image }}
      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ matrix.dockerfile.image }}:scan
          format: table
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: '0'
