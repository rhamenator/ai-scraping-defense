name: Manage Security Alerts and Issues

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes will be made)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      include_dependabot:
        description: 'Include Dependabot alerts (requires Dependabot alerts enabled)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  manage-alerts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests PyGithub

      - name: Run alert management script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "Running in DRY RUN mode"
          else
            echo "Running in LIVE mode - changes will be made"
          fi

          # Extract repo name from full repository path (owner/repo)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          INCLUDE_DEPENDABOT="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.include_dependabot || 'true' }}"

          python scripts/manage_alerts_issues_prs.py \
            --owner ${{ github.repository_owner }} \
            --repo "$REPO_NAME" \
            --include-dependabot "$INCLUDE_DEPENDABOT" \
            $DRY_RUN_FLAG

      - name: Upload report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        if: always()
        with:
          name: alert-management-report-${{ github.run_number }}
          path: alert_management_report_*.txt
          retention-days: 30

      - name: Comment on workflow run
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('.').filter(f => f.startsWith('alert_management_report_'));

            if (reportFiles.length > 0) {
              const report = fs.readFileSync(reportFiles[0], 'utf8');
              const statsSection = report.split('STATISTICS:')[1]?.split('ACTIONS LOG:')[0] || 'No statistics available';

              const dryRun = '${{ github.event.inputs.dry_run }}' === 'true';
              const runNumber = '${{ github.run_number }}';

              const modeText = dryRun ? 'DRY RUN' : 'LIVE';
              const comment = '## Alert Management Report\n\n' +
                '**Mode**: ' + modeText + '\n' +
                '**Workflow Run**: ' + runNumber + '\n\n' +
                '### Statistics\n' +
                '```\n' +
                statsSection.trim() + '\n' +
                '```\n\n' +
                'Full report available in workflow artifacts.\n';

              // Note: This would need to be connected to an issue or PR
              // For now, it just prepares the comment
              console.log(comment);
            }
