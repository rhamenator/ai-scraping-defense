name: k8s-smoke

on:
  workflow_dispatch:
    inputs:
      install_full_requirements:
        description: Install requirements-kubernetes.txt instead of only kubernetes
        required: false
        type: boolean
        default: false
      python_version:
        description: Python version to use
        required: false
        type: string
        default: "3.11"

permissions:
  contents: read

jobs:
  kind-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ inputs.python_version }}
      - name: Create kind cluster
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab
        with:
          cluster_name: asd-smoke
          wait: 120s
      - name: Cluster sanity check
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide
      - name: Install kubernetes client only
        if: ${{ !inputs.install_full_requirements }}
        run: |
          python -m pip install --upgrade pip
          pip install kubernetes
      - name: Install optional Kubernetes requirements
        if: ${{ inputs.install_full_requirements }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-kubernetes.txt -c constraints.txt
      - name: Python Kubernetes smoke test
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import os
          from kubernetes import client, config

          kubeconfig = os.environ.get("KUBECONFIG")
          if kubeconfig:
            config.load_kube_config(config_file=kubeconfig)
          else:
            config.load_kube_config()

          api = client.CoreV1Api()
          namespaces = api.list_namespace()
          print("Namespace count:", len(namespaces.items))
          print("First namespace:", namespaces.items[0].metadata.name)
          PY
