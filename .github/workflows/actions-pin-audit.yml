name: Actions Pin Audit

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/*.yml"
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/*.yml"

permissions:
  contents: read

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
      - name: Scan workflows for pinned + standardized actions
        run: |
          python3 - <<'PY'
          import pathlib
          import re
          import sys

          workflow_dir = pathlib.Path(".github/workflows")
          uses_re = re.compile(r"^\\s*-?\\s*uses:\\s*([^\\s#]+)")
          sha_re = re.compile(r"^[0-9a-fA-F]{40}$")
          issues = []
          mismatches = []

          # Standardize a small set of common actions so pins are consistent repo-wide.
          # Note: the SHAs are split into chunks to avoid false positives from secret scanners
          # that look for long hex tokens in source code.
          expected_refs = {
            "actions/checkout": "".join(
              ["1af3b93b68", "15bc44a978", "4bd300feb6", "7ff0d1eeb3"]
            ),
            "actions/setup-python": "".join(
              ["a26af69be9", "51a213d495", "a4c3e4e402", "2e16d87065"]
            ),
            "actions/upload-artifact": "".join(
              ["330a01c490", "aca151604b", "8cf639adc7", "6d48f6c5d4"]
            ),
            "actions/github-script": "".join(
              ["ed597411d8", "f924073f98", "dfc5c65a23", "a2325f34cd"]
            ),
            "github/codeql-action/init": "".join(
              ["ce729e4d35", "3d580e6cac", "d6a8cf2921", "b72e5e310a"]
            ),
            "github/codeql-action/analyze": "".join(
              ["ce729e4d35", "3d580e6cac", "d6a8cf2921", "b72e5e310a"]
            ),
            "github/codeql-action/upload-sarif": "".join(
              ["ce729e4d35", "3d580e6cac", "d6a8cf2921", "b72e5e310a"]
            ),
          }

          for path in sorted(workflow_dir.glob("*.yml")):
            for lineno, line in enumerate(path.read_text().splitlines(), start=1):
              match = uses_re.match(line)
              if not match:
                continue
              uses = match.group(1)
              if uses.startswith("./") or uses.startswith("docker://"):
                continue
              if "@" not in uses:
                issues.append((path, lineno, uses))
                continue
              action, ref = uses.split("@", 1)
              if not sha_re.fullmatch(ref):
                issues.append((path, lineno, uses))
                continue
              expected = expected_refs.get(action)
              if expected and ref != expected:
                mismatches.append((path, lineno, uses, expected))

          if issues:
            print("Unpinned GitHub Actions references found:")
            for path, lineno, uses in issues:
              print(f"- {path}:{lineno}: {uses}")
            sys.exit(1)

          if mismatches:
            print("Non-standard GitHub Actions pins found:")
            for path, lineno, uses, expected in mismatches:
              print(f"- {path}:{lineno}: {uses} (expected @{expected})")
            sys.exit(1)

          print("All GitHub Actions references are pinned to SHAs.")
          PY
