# Base ModSecurity configuration
Include /etc/nginx/modsecurity/crs-setup.conf
Include /etc/nginx/modsecurity/rules/*.conf

# XXE Protection: Enable request body inspection for XML content
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Enable XML request body parsing with secure settings
SecRule REQUEST_HEADERS:Content-Type "(?:application|text)/xml" \
    "id:200000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyProcessor=XML"

# Disable XML external entity processing (XXE protection)
SecXmlExternalEntity Off

# Enable response body inspection for XML content
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json

# Block suspicious XML-based attacks in response
SecRule RESPONSE_BODY "@rx (?i)<!(?:DOCTYPE|ENTITY)" \
    "id:200001,\
    phase:4,\
    deny,\
    status:500,\
    log,\
    msg:'XXE: Suspicious XML structure in response blocked'
